---
// BrandsCarousel.astro
// Reusable component for infinite logo carousel in a single row

import { urlFor } from '@/lib/sanity' 

interface SanityImage {
  asset: {
    _ref: string
  }
}

interface Brand {
  image: SanityImage
  alt: string
}

interface Props {
  brands: Brand[]
  duration?: number
  title?: string
}

const { 
  brands = [],
  duration = 40,
  title = "Our expertise flows across CPG, B2B and retail.",
} = Astro.props;

---

<div class="brands-carousel" data-duration={duration}>
  {title && (
    <h3 class="brands-carousel__title">{title}</h3>
  )}

  <div class="brands-carousel__container">
    <div class="brands-carousel__row">
      <div class="brands-carousel__track">
        <div class="brands-carousel__brands"> 
          {brands.map((brand) => (
            <img
              src={urlFor(brand.image).width(300).auto('format').url()}
              alt={brand.alt}
            />
          ))}
        </div>
        <!-- Duplicate for infinite loop -->
        <div class="brands-carousel__brands"> 
          {brands.map(b => (
            <img
              src={urlFor(b.image).width(300).auto('format').url()}
              alt={b.alt}
            />
          ))}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import gsap from 'gsap';
  import { initSplitText } from '../scripts/utils/splittext.js'; 

  /**
   * Initializes the infinite logo carousel
   * @param duration - Animation duration in seconds (higher = slower)
   */
  function initBrandsCarousel(duration: number = 40) {
    const track = document.querySelector('.brands-carousel__track') as HTMLElement;

    if (!track) {
      console.warn('BrandsCarousel: Track not found');
      return;
    }

    // Wait for images to load to calculate width correctly
    const container = document.querySelector('.brands-carousel__container');
    if (!container) return;

    const images = container.querySelectorAll('img');
    let imagesLoaded = 0;
    const totalImages = images.length;

    if (totalImages === 0) {
      startCarousel();
      return;
    }

    const checkAndStart = () => {
      imagesLoaded++;
      if (imagesLoaded === totalImages) {
        startCarousel();
      }
    };

    images.forEach((img) => {
      if ((img as HTMLImageElement).complete) {
        checkAndStart();
      } else {
        img.addEventListener('load', checkAndStart);
        img.addEventListener('error', checkAndStart);
      }
    });

    function startCarousel() {
      // Calculate the width of a logo set
      const brands = track.querySelector('.brands-carousel__brands') as HTMLElement;
      
      if (!brands) {
        console.warn('BrandsCarousel: Brands not found');
        return;
      }

      const brandsWidth = brands.offsetWidth;

      // Animate track: left to right (moves to the left)
      gsap.fromTo(track, 
        { x: 0 },
        {
          x: -brandsWidth,
          duration,
          ease: "none",
          repeat: -1,
        }
      );
    }
  }

  // Initialize when DOM is ready
  if (typeof window !== 'undefined') {
    const carouselElement = document.querySelector('.brands-carousel') as HTMLElement;
    const carouselDuration = carouselElement?.dataset.duration 
      ? parseInt(carouselElement.dataset.duration, 10) 
      : 40;

    if (document.readyState === 'complete') {
      initBrandsCarousel(carouselDuration);
    } else {
      window.addEventListener('load', () => initBrandsCarousel(carouselDuration));
    }
  }

  const title = document.querySelector('h3.brands-carousel__title') as HTMLElement;
  if (title) {
    initSplitText(title, { 
      type: 'words',
      stagger: 0.05  // More overlap between characters
    });
  }
</script>
