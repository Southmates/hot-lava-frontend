---
// Loader.astro
---

<div class="loader" id="loader">
  <div class="loader__wrapper">
    <img src="/logo.svg" alt="Hot Lava" class="loader__logo" />
    <div class="loader__content">
      <div class="loader__spinner"></div>
      <div class="loader__status" id="loader-status">
        <span class="loader__status-text">Starting</span>
      </div>
    </div>
  </div>
</div>

<script>
  import { waitForCriticalImages } from '../scripts/utils/images-ready.js';

  // Function to update loader status with animation
  function updateLoaderStatus(statusElement: HTMLElement, text: string, minDisplayTime: number = 500) {
    return new Promise<void>((resolve) => {
      // Fade out current text
      statusElement.classList.add('loader__status--fade-out');
      
      setTimeout(() => {
        // Update text
        const textElement = statusElement.querySelector('.loader__status-text');
        if (textElement) {
          textElement.textContent = text;
        }
        
        // Fade in new text
        statusElement.classList.remove('loader__status--fade-out');
        statusElement.classList.add('loader__status--fade-in');
        
        // Wait minimum display time
        setTimeout(() => {
          statusElement.classList.remove('loader__status--fade-in');
          resolve();
        }, minDisplayTime);
      }, 200); // Fade out duration
    });
  }

  // Wait for fonts and critical images to load before removing loader
  async function initLoader() {
    const loader = document.getElementById('loader');
    const statusElement = document.getElementById('loader-status');
    if (!loader || !statusElement) return;

    const startTime = Date.now();
    const minDisplayTime = 1500; // 1.5 segundos m√≠nimo total

    try {
      // Step 1: Show text and wait for fonts
      await updateLoaderStatus(statusElement, 'Loading Fonts', 500);
      
      // Wait for fonts
      await new Promise<void>((resolve) => {
        const handleFontsReady = () => {
          resolve();
        };
        
        window.addEventListener('fontsReady', handleFontsReady, { once: true });
        
        // Fallback for fonts
        document.fonts.ready.then(() => {
          setTimeout(() => {
            if (!(window as any).fontsReadyDispatched) {
              resolve();
            }
          }, 100);
        });
      });
      
      // Step 2: Show text and wait for images
      await updateLoaderStatus(statusElement, 'Getting images', 500);
      
      // Wait for critical images
      await new Promise<void>((resolve) => {
        waitForCriticalImages(() => {
          resolve();
        });
      });
      
      // Additional wait to ensure everything is fully rendered
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Calculate remaining time to ensure minimum display time
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, minDisplayTime - elapsed);
      
      // Wait for remaining time if needed
      if (remaining > 0) {
        await new Promise(resolve => setTimeout(resolve, remaining));
      }
      
      // Remove loader
      loader.classList.add('loader--hidden');
      
      // Mark that assets are ready and dispatch custom events
      (window as any).fontsReadyDispatched = true;
      window.dispatchEvent(new CustomEvent('fontsReady'));
      window.dispatchEvent(new CustomEvent('assetsReady'));
      
      // Dispatch event when loader animation completes (after transition)
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('loaderComplete'));
        loader.remove();
      }, 500);
      
    } catch (error) {
      console.warn('Asset loading error:', error);
      // Even if there's an error, ensure minimum display time
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, minDisplayTime - elapsed);
      
      setTimeout(() => {
        loader.classList.add('loader--hidden');
        (window as any).fontsReadyDispatched = true;
        window.dispatchEvent(new CustomEvent('fontsReady'));
        window.dispatchEvent(new CustomEvent('assetsReady'));
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('loaderComplete'));
          loader.remove();
        }, 500);
      }, remaining);
    }
  }

  // Initialize loader when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLoader);
  } else {
    initLoader();
  }
</script>

<style>
  .loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background-color: var(--color-darkBlue, #103B60);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
  }

  .loader--hidden {
    opacity: 0;
    transform: translateY(-100%);
    transition: opacity 0.95s ease-out, transform 0.5s ease-out;
    pointer-events: none;
  }

  .loader__wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4rem;
    width: 100%;
    height: 100vh; 
  }

  .loader__content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    gap: 1rem;

    width: 100%;
    height: 100%;   
    padding-bottom: 10vh;
  }

  .loader__logo {
    width: min(100%, 90px);
    height: auto; 
    display: block;
  }

  .loader__spinner {
    width: 32px;
    height: 32px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-top-color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .loader__status { 
    min-height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .loader__status-text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.875rem;
    font-weight: 500;  
    opacity: 1;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  }

  .loader__status--fade-out .loader__status-text {
    opacity: 0;
    transform: translateY(-10px);
  }

  .loader__status--fade-in .loader__status-text {
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.3s ease-out forwards;
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

