---
// Works.astro
import { urlFor } from '@/lib/sanity'

// Data fetching for brands carousel
import BrandsCarousel from '../BrandsCarousel.astro';
import { getBrands } from '@/data/brands';
const brands = await getBrands();

interface SanityImage {
  asset: {
    _ref: string
  }
}

interface WorkItem {
  brand: string
  name: string
  slide: string
  image: SanityImage
  videoUrl?: string
}


interface Props {
  asterisk?: string;
  title?: string;
  works?: WorkItem[];
  carouselTitle?: string;
  carouselDuration?: number;
} 

const {
  asterisk = '*',
  title = 'See how we flow',
  works,
  carouselTitle = 'Our expertise flows across CPG, B2B and retail.',
  carouselDuration = 40,
} = Astro.props;

if (!works?.length) return null
 
---

<section id="work" class="works">   
  <div class="wrapper">
    <div class="container works__container">
      <h3 class="title">
        <span class="asterisk">{asterisk}</span>{title}
      </h3>
      
      <div class="works__list">
        {works.map((work) => (
          <div class="work">
            <div 
              class={`work__item js-work ${work.videoUrl ? 'js-work--has-video' : ''}`}
              data-slide={work.slide}
              data-video={work.videoUrl || ''}
            >
              {work.brand && <span class="brand">{work.brand}</span>}
              <div class="name">
                <p>{work.name}<span class="underline"></span></p>
              </div>
              <img
                src={
                  work.image
                    ? urlFor(work.image).width(900).auto('format').url()
                    : '/work/placeholder.jpg'
                }
                alt={work.name}
                class="work__image"
                loading="lazy"
              />
            </div>
          </div>
        ))}
      </div>

      <div class="works__images">
        <!-- Work images will be loaded dynamically -->
      </div>
    </div>
  </div>

  <div class="logos">
    <BrandsCarousel 
      title={carouselTitle}
      duration={carouselDuration}
      brands={brands}
    />
  </div>
</section>

<script>
  import { initSplitText } from '../../scripts/utils/splittext.js';
  import { initCustomCursor } from '../../scripts/utils/custom-cursor.js';
  import gsap from 'gsap';

  // Initialize underline animation on hover
  function initUnderlineAnimation() {
    const workItems = document.querySelectorAll('.work__item');
    
    workItems.forEach((item) => {
      const underline = item.querySelector('.name p .underline') as HTMLElement;
      if (!underline) return;

      // Set initial state
      gsap.set(underline, {
        width: 0,
      });

      // Animate on hover
      item.addEventListener('mouseenter', () => {
        gsap.to(underline, {
          width: '100%',
          duration: 0.4,
          ease: 'power3.out', // Smooth custom ease
        });
      });

      // Reverse on mouse leave
      item.addEventListener('mouseleave', () => {
        gsap.to(underline, {
          width: 0,
          duration: 0.4,
          ease: 'power3.in', // Smooth custom ease
        });
      });
    });
  }

  if (typeof window !== 'undefined') {
    if (document.readyState === 'complete') {
      initUnderlineAnimation();
    } else {
      window.addEventListener('load', initUnderlineAnimation);
    }
  }

  // Position work images vertically aligned with their corresponding text
  function positionWorkImages() {
    const workItems = document.querySelectorAll('.work__item');
    
    workItems.forEach((item) => {
      const image = item.querySelector('.work__image') as HTMLElement;
      if (!image) return;

      const updatePosition = () => {
        const rect = item.getBoundingClientRect();
        const centerY = rect.top + rect.height / 2;
        image.style.top = `${centerY}px`;
        image.style.transform = `translateY(-50%) translateX(40px)`;
      };

      // Update position on load and scroll
      updatePosition();
      window.addEventListener('scroll', updatePosition, { passive: true });
      window.addEventListener('resize', updatePosition, { passive: true });

      // Update on hover
      item.addEventListener('mouseenter', () => {
        updatePosition();
        image.style.transform = `translateY(-50%) translateX(0)`;
      });
    });
  }

  if (typeof window !== 'undefined') {
    if (document.readyState === 'complete') {
      positionWorkImages();
    } else {
      window.addEventListener('load', positionWorkImages);
    }
  }

  // Initialize SplitText for footer title
  const title = document.querySelector('.works h3.title') as HTMLElement;
  if (title) {
    initSplitText(title, { 
      type: 'character',
      stagger: 0.02  // More overlap between characters
    });
  }

  // Initialize custom cursor for work items
  if (typeof window !== 'undefined') {
    if (document.readyState === 'complete') {
      initCustomCursor('.work__item', {
        text: 'View',
        cursorId: 'work-cursor',
      });
    } else {
      window.addEventListener('load', () => {
        initCustomCursor('.work__item', {
          text: 'View',
          cursorId: 'work-cursor',
        });
      });
    }
  }
 
</script>
