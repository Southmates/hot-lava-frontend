---
// About.astro
import { urlFor } from '../../lib/sanity'

interface SanityImage {
  asset?: { _ref?: string };
}

type TeamImage = string | SanityImage;

interface TeamMember {
  name: string;
  surname: string;
  image: TeamImage;
  bio: string;
}

function resolveTeamImage(image: TeamImage): string {
  if (typeof image === 'string') {
    return image;
  }
  return urlFor(image).width(600).auto('format').url();
}

interface AboutIntroTitle {
  line1: string;
  line2?: string | null;
}

interface AboutIntro {
  title: string | AboutIntroTitle;
}

interface Props {
  intro?: AboutIntro;
  team: TeamMember[];
  logo?: {
    src: string;
    alt: string;
    style?: string;
  };
}

const defaultIntro: AboutIntro = {
  title: 'Who we are',
};

const defaultLogo = {
  src: '/logo-hot-lava-outline.svg',
  alt: 'Hot Lava',
  style: 'opacity: .25; filter: invert(1) saturate(10);',
};

const { intro = defaultIntro, team, logo = defaultLogo } = Astro.props;

const titleText =
  typeof intro.title === 'string'
    ? intro.title
    : intro.title?.line1 ?? defaultIntro.title as string;
const titleLine2 =
  typeof intro.title === 'object' ? intro.title?.line2 : null;

---

<section id="about-us" class="about">
  <div class="wrapper">
    <div class="container about__intro">
      <h3 class="title">
        <span class="asterisk">*</span>{titleText}
        {titleLine2 && (
          <>
            <br />
            {titleLine2}
          </>
        )}
      </h3>
    </div> 
    
    <div class="container about__team">
      <div class="team"> 
        {team.map((member) => (
          <div class="team__card">  
            <h3 class={`team__name team__name--${member.name.toLowerCase()}`}>{member.name} <span class="team__surname">{member.surname}</span></h3>
            <picture>
              <img
                src={resolveTeamImage(member.image)}
                alt={member.name}
                data-critical="true"
                loading="eager"
              />

              <div class="team__overlay"></div>
            </picture>
            <p class="team__bio">{member.bio}</p>
          </div>
        ))}
      </div>
    </div> 
  </div>

  <div class="logo logo--vertical"> 
    <img 
      src={logo.src} 
      alt={logo.alt} 
      style={logo.style}
    />
  </div>
</section>

<script>
  import { initSplitText } from '../../scripts/utils/splittext.js';
  import { waitForAssets } from '../../scripts/utils/images-ready.js';
  import { initParallax } from '../../scripts/utils/parallax.js';
  import { initUkiyo } from '../../scripts/utils/ukiyo.js'; 
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { SplitText } from 'gsap/SplitText';

  gsap.registerPlugin(ScrollTrigger);

  // Wait for fonts and critical images to be ready before initializing SplitText
  waitForAssets(() => {
    // Initialize SplitText for title (words)
    const title = document.querySelector('.about h3.title') as HTMLElement;
    if (title) {
      initSplitText(title, { type: 'character', stagger: 0.02 });
    }

    // Initialize SplitText for bios with hover animation
    const bios = document.querySelectorAll('.about .team__bio') as NodeListOf<HTMLElement>;
    bios.forEach((bio) => {
      const split = new SplitText(bio, {
        type: 'lines',
        linesClass: 'line',
      });

      const lines = split.lines;

      // Set initial state
      gsap.set(lines, {
        opacity: 0,
        y: 50,
      });

      // Get the parent card
      const card = bio.closest('.team__card') as HTMLElement;
      if (!card) return;

      // Store split data on the card for cleanup
      (card as any).__splitData = { split, lines };

      // Animate on hover
      card.addEventListener('mouseenter', () => {
        gsap.to(lines, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          stagger: 0.05,
          ease: 'power2.out',
        });
      });

      // Reverse on mouse leave
      card.addEventListener('mouseleave', () => {
        gsap.to(lines, {
          opacity: 0,
          y: 50,
          duration: 0.5,
          stagger: 0.03,
          ease: 'power2.in',
        });
      });
    }); 

    // Fade-in team cards on scroll (once)
    const cards = gsap.utils.toArray<HTMLElement>('.about .team__card');
    if (cards.length) {
      gsap.set(cards, { opacity: 0 });

      ScrollTrigger.batch(cards, {
        start: 'top 85%',
        once: true,
        onEnter: (batch) => {
          gsap.to(batch, {
            opacity: 1, 
            duration: 2,
            ease: 'power2.out',
            stagger: 0.2,
            overwrite: 'auto',
          });
        },
      });
    }
  });

  initParallax('.about h3.title', {
    speed: 1  
  });

  initParallax('.about .logo--vertical', {
    speed: 7  
  });   

  initUkiyo('.about .team__card img', {
    scale: 1.15,
    speed: 1.1
  });
</script>
 
