---
// About.astro

interface TeamMember {
  name: string;
  surname: string;
  image: string;
  bio: string;
}

interface AboutIntro {
  title: string;
  // paragraph: string;
}

interface Props {
  asterisk?: string;
  intro?: AboutIntro;
  team?: TeamMember[];
  logo?: {
    src: string;
    alt: string;
    style?: string;
  };
}

// Default data - will be replaced by CMS data
const defaultIntro: AboutIntro = {
  title: 'Who we are',
  // paragraph: 'Could we add some text here...?',
};

const defaultTeam: TeamMember[] = [
  {
    name: 'Ben',
    surname: 'Kline',
    image: '/team/ben.jpg',
    bio: "Previously CMO for Ogilvy, and CSO at Leo Burnett, Ben is an industry veteran who has made invaluable strategic contributions to a diverse portfolio of global brands.",
  },
  {
    name: 'Nik',
    surname: 'Traxler',
    image: '/team/nik.jpg',
    bio: "Nik is an award-winning producer whose talent flexes to agency operations. With global brand and agency experience, he goes above and beyond in pursuit of excellence.",
  },
  {
    name: 'Phil',
    surname: 'Jungmann',
    image: '/team/phil.jpg',
    bio: "Phil's thoughtful and boundary-pushing art direction and creative leadership has resulted in impactful and award-winning work for the world's top brands, at the best agencies in Chicago and NYC.",
  },
  {
    name: 'Kristi',
    surname: 'Neitzel',
    image: '/team/kristi.jpg',
    bio: "Kristi is a creative leader and writer with a client roster of Fortune 500 greats. Her ability to manage, motivate and organize agency and client-side teams that work together seamlessly is unmatched.",
  },
];

const defaultLogo = {
  src: '/logo-hot-lava-outline.svg',
  alt: 'Hot Lava',
  style: 'opacity: .25; filter: invert(1) saturate(10);',
};

const {
  asterisk = '*',
  intro = defaultIntro,
  team = defaultTeam,
  logo = defaultLogo,
} = Astro.props;
---

<section id="about-us" class="about">
  <div class="wrapper">
    <div class="container about__intro"> 
      <h3 class="title">
        <span class="asterisk">{asterisk}</span>{intro.title}
      </h3>
      <!-- <p class="paragraph">{intro.paragraph}</p> -->
    </div> 
    
    <div class="container about__team">
      <div class="team"> 
        {team.map((member) => (
          <div class="team__card">  
            <h3 class={`team__name team__name--${member.name.toLowerCase()}`}>{member.name} <span class="team__surname">{member.surname}</span></h3>
            <picture>
              <img 
                src={member.image} 
                alt={member.name} 
                data-critical="true" 
                loading="eager" 
              />
              <div class="team__overlay"></div>
            </picture>
            <p class="team__bio">{member.bio}</p>
          </div>
        ))}
      </div>
    </div> 
  </div>

  <div class="logo logo--vertical"> 
    <img 
      src={logo.src} 
      alt={logo.alt} 
      style={logo.style}
    />
  </div>
</section>

<script>
  import { initSplitText } from '../../scripts/utils/splittext.js';
  import { waitForAssets } from '../../scripts/utils/images-ready.js';
  import { initParallax } from '../../scripts/utils/parallax.js';
  import { initUkiyo } from '../../scripts/utils/ukiyo.js';
  import { initFadeIn } from '../../scripts/utils/fade-in.js';
  import gsap from 'gsap';
  import { SplitText } from 'gsap/SplitText';

  // Wait for fonts and critical images to be ready before initializing SplitText
  waitForAssets(() => {
    // Additional check to ensure fonts are fully loaded before creating SplitText
    const initWhenFontsReady = () => {
      // Small delay to ensure fonts are fully rendered
      setTimeout(() => {
        // Initialize SplitText for title (words)
        const title = document.querySelector('.about h3.title') as HTMLElement;
        if (title) {
          initSplitText(title, { type: 'character', stagger: 0.02 });
        }

        // Initialize SplitText for bios with hover animation
        const bios = document.querySelectorAll('.about .team__bio') as NodeListOf<HTMLElement>;
        bios.forEach((bio) => {
          const split = new SplitText(bio, {
            type: 'lines',
            linesClass: 'line',
          });

          const lines = split.lines;

          // Set initial state
          gsap.set(lines, {
            opacity: 0,
            y: 50,
          });

          // Get the parent card
          const card = bio.closest('.team__card') as HTMLElement;
          if (!card) return;

          // Store split data on the card for cleanup
          (card as any).__splitData = { split, lines };

          // Animate on hover
          card.addEventListener('mouseenter', () => {
            gsap.to(lines, {
              opacity: 1,
              y: 0,
              duration: 0.8,
              stagger: 0.05,
              ease: 'power2.out',
            });
          });

          // Reverse on mouse leave
          card.addEventListener('mouseleave', () => {
            gsap.to(lines, {
              opacity: 0,
              y: 50,
              duration: 0.5,
              stagger: 0.03,
              ease: 'power2.in',
            });
          });
        });

        // Initialize fade-in for team cards
        initFadeIn('.team__card', {
          start: '50%',
          duration: 2.4,
          y: 50,
          ease: 'power4.out',
        });
      }, 100);
    };

    // Check if fonts are already ready
    if ((window as any).fontsReadyDispatched) {
      initWhenFontsReady();
    } else {
      // Wait for fontsReady event
      const handleFontsReady = () => {
        initWhenFontsReady();
      };
      
      window.addEventListener('fontsReady', handleFontsReady, { once: true });
      
      // Fallback: check if fonts are already loaded
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
          setTimeout(() => {
            if (!(window as any).fontsReadyDispatched) {
              window.removeEventListener('fontsReady', handleFontsReady);
              initWhenFontsReady();
            }
          }, 100);
        });
      }
    }
  });

  initParallax('.about h3.title', {
    speed: 1  
  });

  initParallax('.about .logo--vertical', {
    speed: 7  
  });   

  // Ukiyo sets inline styles/wrappers; on resize (responsive preview) those can get stale
  // and break layout. Approach: debounce resize and refresh/teardown + re-init as needed.
  const UKIYO_WRAPPER_CLASS = 'ukiyo-wrapper';
  const DESKTOP_BREAKPOINT = 780; // matches menu breakpoint
  let teamUkiyoInstances: any[] = [];

  function cleanupAboutInlineStyles() {
    // Clear inline transforms that can override responsive CSS
    const cards = document.querySelectorAll('.about .team__card') as NodeListOf<HTMLElement>;
    const pictures = document.querySelectorAll('.about .team__card picture') as NodeListOf<HTMLElement>;
    const imgs = document.querySelectorAll('.about .team__card img') as NodeListOf<HTMLElement>;

    gsap.set(cards, { clearProps: 'transform' });
    gsap.set(pictures, { clearProps: 'transform' });
    gsap.set(imgs, { clearProps: 'transform' });

    imgs.forEach((img) => {
      img.style.willChange = '';
    });
  }

  function unwrapUkiyo() {
    // Unwrap ukiyo wrappers if present
    document.querySelectorAll(`.about .${UKIYO_WRAPPER_CLASS}`).forEach((wrapper) => {
      const img = wrapper.querySelector('img');
      if (!img || !wrapper.parentNode) return;
      wrapper.parentNode.insertBefore(img, wrapper);
      wrapper.remove();
    });
  }

  function destroyTeamUkiyo() {
    teamUkiyoInstances.forEach((inst) => {
      try {
        if (!inst) return;
        // Try common teardown APIs across versions
        if (typeof inst.destroy === 'function') inst.destroy();
        else if (typeof inst.disable === 'function') inst.disable();
        else if (typeof inst.stop === 'function') inst.stop();
      } catch {
        // ignore
      }
    });
    teamUkiyoInstances = [];
    unwrapUkiyo();
    cleanupAboutInlineStyles();
  }

  function initTeamUkiyo() {
    // Ensure no double-wrapping
    destroyTeamUkiyo();
    teamUkiyoInstances = initUkiyo('.about .team__card img', {
      scale: 1.15,
      speed: 1.1,
    }) as any[];
  }

  function refreshTeamUkiyo() {
    const isDesktop = window.innerWidth >= DESKTOP_BREAKPOINT;

    if (!isDesktop) {
      // On mobile, disable ukiyo so layout stacks correctly
      destroyTeamUkiyo();
      return;
    }

    // Desktop: prefer lightweight refresh if API exists
    if (teamUkiyoInstances.length) {
      let refreshed = false;
      teamUkiyoInstances.forEach((inst) => {
        try {
          if (!inst) return;
          if (typeof inst.update === 'function') {
            inst.update();
            refreshed = true;
          } else if (typeof inst.resize === 'function') {
            inst.resize();
            refreshed = true;
          }
        } catch {
          // ignore
        }
      });
      if (refreshed) return;
    }

    // Fallback: re-init
    initTeamUkiyo();
  }

  // Init + refresh on resize (debounced)
  refreshTeamUkiyo();
  let ukiyoResizeTimer: number | undefined;
  window.addEventListener('resize', () => {
    window.clearTimeout(ukiyoResizeTimer);
    ukiyoResizeTimer = window.setTimeout(() => {
      refreshTeamUkiyo();
    }, 200);
  }, { passive: true });
</script>

<style>
  .lines-about {
    pointer-events: none;
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: auto; 
    opacity: 0.5;
    z-index: -1;
  }
</style>
