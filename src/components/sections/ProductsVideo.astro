---
// ProductsVideo.astro - Version with video background

interface Product {
  id: number;
  name: string;
  image: string;
  hoverImage: string;
  url: string;
  darkBackground?: boolean;
}

interface Props {
  products?: Product[];
  videoUrl?: string; // Vimeo URL for background video
}

// Default products data - will be replaced by CMS data
const defaultProducts: Product[] = [
  { 
    id: 1, 
    name: 'Flow Generator Lamp', 
    image: '/shop/01.png',
    hoverImage: '/shop/01.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-boxed-lava-lamp',
    darkBackground: true
  },
  { 
    id: 2, 
    name: 'Hot Sauce Original Trio', 
    image: '/shop/02.png',
    hoverImage: '/shop/02.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-boxed-hot-sauces',
    darkBackground: true
  },
  { 
    id: 3, 
    name: 'Lava Scented Candle', 
    image: '/shop/03.png',
    hoverImage: '/shop/03.webp',
    url: 'https://shop.hotlavaagency.com/products/concrete-candle-lava-scent',
    darkBackground: true
  },
  { 
    id: 4, 
    name: 'Volcanic Hoodie', 
    image: '/shop/04.png',
    hoverImage: '/shop/04.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-hoodie',
    darkBackground: true
  },
  { 
    id: 5, 
    name: 'Ember Key Charm', 
    image: '/shop/05.png',
    hoverImage: '/shop/05.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-keychain',
    darkBackground: true
  },
  { 
    id: 6, 
    name: 'Ember Thinking Cap', 
    image: '/shop/06.png',
    hoverImage: '/shop/06.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-hat',
    darkBackground: true
  },
  { 
    id: 7, 
    name: 'Flow Generator Lamp', 
    image: '/shop/01.png',
    hoverImage: '/shop/01.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-boxed-lava-lamp',
    darkBackground: true
  },
  { 
    id: 8, 
    name: 'Hot Sauce Original Trio', 
    image: '/shop/02.png',
    hoverImage: '/shop/02.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-boxed-hot-sauces',
    darkBackground: true
  },
  { 
    id: 9, 
    name: 'Lava Scented Candle', 
    image: '/shop/03.png',
    hoverImage: '/shop/03.webp',
    url: 'https://shop.hotlavaagency.com/products/concrete-candle-lava-scent',
    darkBackground: true
  },
  { 
    id: 10, 
    name: 'Volcanic Hoodie', 
    image: '/shop/04.png',
    hoverImage: '/shop/04.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-hoodie',
    darkBackground: true
  },
  { 
    id: 11, 
    name: 'Ember Key Charm', 
    image: '/shop/05.png',
    hoverImage: '/shop/05.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-keychain',
    darkBackground: true
  },
  { 
    id: 12, 
    name: 'Ember Thinking Cap', 
    image: '/shop/06.png',
    hoverImage: '/shop/06.webp',
    url: 'https://shop.hotlavaagency.com/products/hot-lava-hat',
    darkBackground: true
  },
];

const { products = defaultProducts, videoUrl = '' } = Astro.props;

// Check if URL is Vimeo or local file
function isVimeoUrl(url: string): boolean {
  return url.includes('vimeo.com') || url.includes('vimeo.com');
}

// Convert Vimeo URL to embed format
function getVimeoEmbedUrl(url: string) {
  if (!url) return '';
  const videoId = url.match(/\/(\d+)/)?.[1];
  return videoId ? `https://player.vimeo.com/video/${videoId}?autoplay=1&loop=1&muted=1&controls=0&background=1&byline=0&portrait=0&title=0&dnt=1` : '';
}

const isVimeo = videoUrl ? isVimeoUrl(videoUrl) : false;
const embedUrl = isVimeo ? getVimeoEmbedUrl(videoUrl) : '';
const localVideoUrl = !isVimeo && videoUrl ? videoUrl : '';
---

<section id="shop" class="products shop">
  <div class="shop__hero">
    {embedUrl ? (
      <!-- Vimeo iframe -->
      <iframe 
        src={embedUrl}
        class="shop__hero-video shop__hero-video--vimeo"
        frameborder="0"
        allow="autoplay; fullscreen; picture-in-picture"
        loading="eager"
      ></iframe>
    ) : localVideoUrl ? (
      <!-- Local video file -->
      <video 
        class="shop__hero-video shop__hero-video--local"
        autoplay
        loop
        muted
        playsinline
        preload="auto"
      >
        <source src={localVideoUrl} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    ) : (
      <!-- Fallback if no video URL provided -->
      <div class="shop__hero-placeholder">
        <p style="color: #fff; text-align: center; padding: 2rem;">No video URL provided. Add videoUrl in index-video.astro</p>
      </div>
    )}
  </div> 
  <div class="wrapper">
    <div class="shop__logo">
      <img src="/shop/the-lava-shop.gif" alt="The Lava Shop - Est. 2024" />
    </div>
      
    <div class="container products__grid"> 
      {products.map((product) => (
        <a 
          href={product.url} 
          target="_blank" 
          rel="noopener noreferrer"
          class={`product__card product__card--${product.id} ${product.darkBackground ? 'product__card--dark' : ''}`}
        >
          <img 
            src={product.hoverImage} 
            alt={product.name}
            class="product__hover-image"
            loading="lazy"
          />
          <div class="product__content">
            <span class="product__name">{product.name}</span>
            <span class="product__view-text">View Details <span>â†’</span></span>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>

<style>
  .shop__hero {
    position: sticky;
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 1;
    overflow: hidden;
    background: #000;
  }

  .shop__hero-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    pointer-events: none;
    z-index: 0;
    object-fit: cover;
  }

  .shop__hero-video--local {
    object-fit: cover;
  }

  .shop__hero-video--vimeo {
    border: none;
  }

  .shop__hero-placeholder {
    width: 100%;
    height: 100%;
    background: #000;
  }

  .shop .wrapper {
    position: relative;
    z-index: 2;
  }
</style>
