---
// Intro.astro

interface IntroImage {
  src: string;
  alt: string;
  class?: string;
  critical?: boolean;
  loading?: "eager" | "lazy";
  position?: "top" | "row";
}

interface IntroTitle {
  line1: string;
  line2?: string | null;
}

interface IntroSection {
  id: string;
  class?: string;
  title?: IntroTitle;
  paragraph?: string | null; 
  image?: IntroImage | null;
  layout?: "row" | "default";
}

interface IntroConfig {
  asterisk?: string;
  sections: IntroSection[];
  asteriskLinesImage?: {
    src: string;
    alt: string;
    class?: string;
  };
}

const defaultConfig: IntroConfig = {
  asterisk: "*",
  sections: [
    {
      id: "intro-first",
      class: "intro__section--first",      
      image: {
        src: "/images/phrase.jpg",
        alt: "Hot Lava is our phrase for epiphany.",
        class: "image-phrase",
        critical: true,
        loading: "eager",
        position: "top",
      },
      layout: "default",
    },
    {
      id: "intro-second",
      class: "intro__section--second", 
      image: {
        src: "/images/flow.jpg",
        alt: "Ideas need to flow more freely.",
        class: "image-ideas",
        critical: true,
        loading: "eager",
        position: "top",
      },
      layout: "default",
    },
    {
      id: "intro-third",
      class: "intro__section--third",  
      image: null,
      layout: "default",
    },
    {
      id: "intro-fourth",
      class: "intro__section--fourth",      
      image: null,
      layout: "default",
    },
  ],
  asteriskLinesImage: {
    src: "/images/asterisk-lines.svg",
    alt: "Hot Lava",
    class: "asterisk-lines",
  },
};

interface Props {
  config?: any;
}

const { config } = Astro.props;

const sections = defaultConfig.sections.map((section, index) => {
  const key = `section${index + 1}`;
  const cms = config?.[key];

  if (!cms) return section;

  return {
    ...section,
    title: cms.title ?? section.title,
    paragraph: cms.paragraph ?? section.paragraph,
  };
});

const asterisk = config?.asterisk ?? defaultConfig.asterisk;
const asteriskLinesImage =
  config?.asteriskLinesImage ?? defaultConfig.asteriskLinesImage;
---

<section class="intro asterisk-lines-container" id="intro">
  {sections.map((section) => (
    <section
      class={`intro__section ${section.class || ""}`.trim()}
      id={section.id}
    >
      <div class="wrapper">
        {section.image?.position === "top" && section.image?.src && (
          <div class={section.image.class || ""}>
            <img
              src={section.image.src}
              alt={section.image.alt}
              data-critical={section.image.critical ? "true" : undefined}
              loading={section.image.loading || "lazy"}
            />
          </div>
        )}

        <div class="container">
          {section.title?.line1 && (
            <h3 class="title">
              <span class="asterisk">{asterisk}</span>
              {section.title.line1}
              {section.title.line2 && (
                <>
                  <br />
                  {section.title.line2}
                </>
              )}
            </h3>
          )}

          {section.layout === "row" && section.paragraph ? (
            <div class="intro__row">
              {section.image?.position === "row" && section.image?.src && (
                <div class={section.image.class || ""}>
                  <img
                    src={section.image.src}
                    alt={section.image.alt}
                    data-critical={section.image.critical ? "true" : undefined}
                    loading={section.image.loading || "lazy"}
                  />
                </div>
              )}
              <p class="paragraph">
                {section.paragraph}
              </p>
            </div>
          ) : (
            section.paragraph && (
              <p class="paragraph">
                {section.paragraph}
              </p>
            )
          )}
        </div>
      </div>
    </section>
  ))}

  {asteriskLinesImage?.src && (
    <img
      src={asteriskLinesImage.src}
      alt={asteriskLinesImage.alt}
      class={asteriskLinesImage.class || ""}
    />
  )}
</section>

<script>
  import { initSplitText } from '../../scripts/utils/splittext.js';
  import { waitForAssets } from '../../scripts/utils/images-ready.js';
  import { initParallax } from '../../scripts/utils/parallax.js';
  import { initUkiyo } from '../../scripts/utils/ukiyo.js';
  import { initFadeIn } from '../../scripts/utils/fade-in.js';

const safe = (
  selector: string,
  cb: (el: HTMLElement) => void
) => {
  const el = document.querySelector(selector) as HTMLElement | null;
  if (el) cb(el);
};



  waitForAssets(() => {
    document
      .querySelectorAll('.intro__section h3.title')
      .forEach((el) => initSplitText(el, { type: 'words' }));

    document
      .querySelectorAll('.intro__section .paragraph')
      .forEach((el) => initSplitText(el, { type: 'lines' }));

    safe('.image-phrase img', (el) =>
      initFadeIn(el, { start: '50%', duration: 2.4, y: 40, ease: 'power4.out' })
    );

    safe('.image-ideas img', (el) =>
      initFadeIn(el, { start: '50%', duration: 2.4, y: 40, ease: 'power4.out' })
    );
  });

  safe('.intro__section--first h3.title', (el) =>
    initParallax(el, { speed: -0.5 })
  );
  safe('.image-phrase', (el) =>
    initParallax(el, { speed: 1.75 })
  );
  safe('.intro__section--second h3.title', (el) =>
    initParallax(el, { speed: -0.5 })
  );
  safe('.intro__section--second .paragraph-intro', (el) =>
    initParallax(el, { speed: -0.75 })
  );
  safe('.image-ideas', (el) =>
    initParallax(el, { speed: 1.75 })
  );
  safe('.asterisk-lines', (el) =>
    initParallax(el, { speed: 2.5 })
  );
  safe('.intro__section--third h3.title', (el) =>
    initParallax(el, { speed: -0.5 })
  );
  safe('.intro__section--third .paragraph', (el) =>
    initParallax(el, { speed: -0.75 })
  );
  safe('.intro__section--fourth h3.title', (el) =>
    initParallax(el, { speed: -0.5 })
  );
  safe('.intro__section--fourth .paragraph', (el) =>
    initParallax(el, { speed: -0.75 })
  );

  safe('.intro__section--first .image-phrase img', (el) =>
    initUkiyo(el, { scale: 1.25, speed: 1 })
  );
  safe('.intro__section--second .image-ideas img', (el) =>
    initUkiyo(el, { scale: 1.25, speed: 1 })
  );
</script>
